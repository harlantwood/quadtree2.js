/*
 * - quadtree2 0.0.1
 * - Two dimensional quadtree for regions and collision detection.
 * - by Burning Gramma <burninggramma@gmail.com>
 * - https://github.com/burninggramma/quadtree2.js
 * --------------------------------------------
 * built on 2014-01-26
*/
var injector=function(a,b){return"undefined"!=typeof module&&"object"==typeof module.exports?b():a()},Vec2=injector(function(){if(!window.Vec2)throw new Error("Vec2 is a requirement");return window.Vec2},function(){return require("vec2")}),fnName=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("("))},thrower=function(a,b,c){var d=a;throw c&&(d+="_"+c),b&&(d+=" - "),b&&c&&(d+=c+": "),b&&(d+=b),new Error(d)},Quadtree2,Quadtree2Quadrant,Quadtree2Validator;Quadtree2Quadrant=function(a,b){this.leftTop_=a.clone(),this.children_=[],this.objects_=[],this.setSize(b)},Quadtree2Quadrant.prototype={setSize:function(a){a&&(this.size_=a,this.rad_=a.multiply(.5,!0),this.center_=this.leftTop_.add(this.rad_,!0),this.leftBot_=this.leftTop_.clone(),this.leftBot_.y+=a.y,this.rightTop_=this.leftTop_.clone(),this.rightTop_.x+=a.x,this.rightBot_=this.leftTop_.add(a,!0),this.leftMid_=this.center_.clone(),this.leftMid_.x=this.leftTop_.x,this.topMid_=this.center_.clone(),this.topMid_.y=this.leftTop_.y,this.corners_=[this.leftTop_,this.leftBot_,this.rightTop_,this.rightBot_])},makeChildren:function(){return this.children_.length>0?!1:(this.children_.push(new Quadtree2Quadrant(this.leftTop_,this.rad_),new Quadtree2Quadrant(this.topMid_,this.rad_),new Quadtree2Quadrant(this.leftMid_,this.rad_),new Quadtree2Quadrant(this.center_,this.rad_)),!0)},cleanObjects:function(){this.objects_=this.objects_.filter(function(a){return void 0===a})},addObject:function(a){this.objects_.push(a)},removeObjects:function(){var a=this.objects_;return this.objects_=[],a},intersectingChildren:function(a,b){return this.children_.filter(function(c){return c.intersects(a,b)})},intersects:function(a,b){var c=a.subtract(this.center_,!0).abs();return c.x>this.rad_.x+b?!1:c.y>this.rad_.y+b?!1:c.x<=this.rad_.x?!0:c.y<=this.rad_.y?!0:(cornerDistSq=Math.pow(c.x,2)+Math.pow(c.y,2),cornerDistSq<=Math.pow(b,2))},hasChildren:function(){return 0!==this.getChildCount()},getChildCount:function(a){var b=this.children_.length;return a&&this.children_.forEach(function(c){b+=c.getChildCount(a)}),b},getObjectCount:function(a){var b=this.objects_.length;return a&&this.children_.forEach(function(c){b+=c.getObjectCount(a)}),b},getChildren:function(a,b){return b.push.apply(b,this.children_),a&&this.children_.forEach(function(c){c.getChildren(a,b)}),b}},Quadtree2=function(a,b,c,d){var e,f={root_:new Quadtree2Quadrant(new Vec2(0,0)),objects_:{},ids_:0,autoId_:!0,inited_:!1,limit_:void 0,size_:void 0,shapes_:{}},g=new Quadtree2Validator,h={p:"pos_",r:"rad_",R:"rot_",id:"id_"},i={data:{necessary:{size_:g.isVec2,limit_:g.isNumber}},k:{necessary:{p:g.isVec2},c:{necessary:{r:g.isNumber}},r:{necessary:{R:g.isNumber}}}},j={nextId:function(){return++f.ids_},hasCollision:function(a,b){return("c"!==j.getObjShape(a)||"c"!==j.getObjShape(b))&&thrower("NIY","Collision handling does not work for rects YET!"),a[h.r]+b[h.r]>a[h.p].distance(b[h.p])},getSmallestQuadrants:function(a,b,c,d){var e,g;if(b||(b=f.root_),c||(c=[]),g=b.intersectingChildren(a[h.p],a[h.r]),g.length===b.getChildCount())(d||b.intersects(a[h.p],a[h.r]))&&c.push(b);else for(e in g)j.getSmallestQuadrants(a,g[e],c,!0);return c},addObjToQuadrant:function(a,b){var c,d,e,g;b||(b=f.root_),b.hasChildren()?(e=j.getSmallestQuadrants(a,b),1===e.length&&e[0]===b?b.addObject(a):(c=function(b){j.addObjToQuadrant(a,b)},e.forEach(c))):b.getObjectCount()<f.limit_?b.addObject(a):(b.makeChildren(),g=b.removeObjects(),g.push(a),d=function(a){j.addObjToQuadrant(a,b)},g.forEach(d))},getCollisionsInQuadrant:function(a,b){var c,d,e,g=[];if(a||(a=f.root_),b||(b=[]),b.push.apply(b,a.objects_),0===a.children_.length)for(c=0;c<b.length;c++)for(d=c+1;d<b.length;d++)j.hasCollision(b[c],b[d])&&g.push([b[c],b[d]]);for(c in a.children_)e=b.slice(0),g.concat(j.getCollisionInQuadrant(a.children_[c],e));return g},init:function(){g.byCallbackObject(f,i.data.necessary),f.root_.setSize(f.size_.clone()),f.inited_=!0},checkInit:function(a){return a&&!f.inited_&&j.init(),f.inited_},checkObjectKeys:function(a){g.isDefined(a[h.id],h.id),g.hasNoKey(f.objects_,a[h.id],h.id),g.byCallbackObject(a,i.k.necessary,h),g.byCallbackObject(a,i.k[j.getObjShape(a)].necessary,h)},setObjId:function(a){f.autoId_&&(a[h.id]=j.nextId())},setObjShape:function(a){var b=void 0===a[h.r],c=b?h.R:h.r;g.isDefined(a[c],c),f.shapes_[a[h.id]]=b?"r":"c"},getObjShape:function(a){return f.shapes_[a[h.id]]}},k={getLimit:function(){return f.limit_},setLimit:function(a){void 0!==a&&(g.isNumber(a,"limit_"),f.limit_=a)},setObjectKey:function(a,b){g.fnFalse(j.checkInit),void 0!==b&&(g.hasKey(h,a,a),g.isString(b,a),"id"===a&&(f.autoId_=!1),h[a]=b)},getSize:function(){return f.size_.clone()},setSize:function(a){void 0!==a&&(g.isVec2(a,"size_"),f.size_=a.clone())},addObjects:function(a){a.forEach(function(a){k.addObject(a)})},addObject:function(a){g.isDefined(a,"obj"),g.isObject(a,"obj"),j.checkInit(!0),j.setObjId(a),j.setObjShape(a),j.checkObjectKeys(a),j.addObjToQuadrant(a),f.objects_[a[h.id]]=a},getCollidedObjects:function(){return j.checkInit(!0),j.getCollisionsInQuadrant()}},l={debug:function(a){return void 0!==a&&(f.debug_=a),f.debug_},getCount:function(){return Object.keys(f.objects_).length},getQuadrants:function(){return f.root_.getChildren(!0,[f.root_])},getQuadrantCount:function(){return 1+f.root_.getChildCount(!0)},getQuadrantObjectCount:function(){return f.root_.getObjectCount(!0)}};for(e in k)this[e]=k[e];for(e in l)this[e]=l[e];if(d)for(e in j)this[e]=j[e];this.setSize(a),this.setLimit(b),this.setObjectKey("id",c)},Quadtree2Validator=function(){},Quadtree2Validator.prototype={isNumber:function(a,b){"number"!=typeof a&&thrower("NaN","Not a Number",b)},isString:function(a,b){"string"==typeof a||a instanceof String||thrower("NaS","Not a String",b)},isVec2:function(a,b){var c=!1;c="object"!=typeof a||!(a instanceof Vec2),c=c||void 0===a.x||void 0===a.y,c&&thrower("NaV","Not a Vec2",b)},isDefined:function(a,b){void 0===a&&thrower("ND","Not defined",b)},isObject:function(a,b){"object"!=typeof a&&thrower("NaO","Not an Object",b)},hasKey:function(a,b,c){-1===Object.keys(a).indexOf(b)&&thrower("OhnK","Object has no key",c+b)},hasNoKey:function(a,b,c){-1!==Object.keys(a).indexOf(b)&&thrower("OhK","Object has key",c+b)},fnFalse:function(a){a()&&thrower("FarT","function already returns true",fnName(a))},byCallbackObject:function(a,b,c){var d;for(d in b)void 0!==c?b[d](a[c[d]],c[d]):b[d](a[d],d)}},injector(function(){window.Quadtree2=Quadtree2},function(){module.exports=Quadtree2});